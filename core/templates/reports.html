{% extends 'base.html' %}
{% load static %}

{% block title %}Reports | Vericon Constructions{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<style>
  body {
    font-family: 'Lato', sans-serif;
    background-color: #f8fafc;
  }

  .reports-wrapper {
    padding: 20px 30px;
  }

  .badge {
    font-size: 0.85rem;
    margin-right: 5px;
  }

  #reportChart {
    max-width: 500px;
    margin: auto;
  }

  .card h5 {
    font-size: 1.1rem;
  }

  @media (max-width: 768px) {
    .reports-wrapper {
      padding: 15px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="reports-wrapper">

  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary">Reports & Analytics</h2>
    <p class="text-muted">Track Attendance, Payroll, Vendor Services & More</p>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-white bg-primary shadow-sm">
        <div class="card-body">
          <h5>Total Attendance</h5>
          <h3>1024</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-success shadow-sm">
        <div class="card-body">
          <h5>Payroll Processed</h5>
          <h3>â‚¹ 5.2 Lakhs</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-warning shadow-sm">
        <div class="card-body">
          <h5>Vendors Paid</h5>
          <h3>48</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Filter Form -->
  <div class="card mb-3">
    <div class="card-body">
      <form id="reportForm">
        <div class="row g-3">
          <div class="col-md-4">
            <label for="reportType" class="form-label">Report Type</label>
            <select id="reportType" class="form-select" required>
              <option selected disabled>Select...</option>
              <option value="attendance">Attendance</option>
              <option value="payroll">Payroll</option>
              <option value="vendor">Vendor Transactions</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="startDate" class="form-label">Start Date</label>
            <input type="date" id="startDate" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label for="endDate" class="form-label">End Date</label>
            <input type="date" id="endDate" class="form-control" required>
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="btn btn-primary">Generate Report</button>
          <small class="ms-3 text-warning">* Historical data is read-only</small>
        </div>
      </form>
    </div>
  </div>

  <!-- Export Buttons -->
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-outline-secondary me-2" onclick="downloadPDF()">Export as PDF</button>
    <button class="btn btn-outline-secondary" onclick="downloadExcel()">Export as Excel</button>
  </div>

  <!-- Spinner -->
  <div class="text-center" id="loadingSpinner" style="display:none;">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2">Generating Report...</p>
  </div>

  <!-- Filter Chips -->
  <div id="filterChips" class="mb-3" style="display: none;"></div>

  <!-- Chart -->
  <div class="my-4" id="chartContainer" style="display: none;">
    <h5 class="text-center mb-3" id="chartTitle">ðŸ“Š Report Overview</h5>
    <canvas id="reportChart" height="100"></canvas>
  </div>

  <!-- Report Results -->
  <div id="reportResult" class="mt-4" style="display:none;">
    <h5 class="mb-3">ðŸ“‹ Generated Report</h5>
    <table class="table table-bordered" id="reportTable">
      <thead>
        <tr><th>#</th><th>Name</th><th>Date</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Audit Logs -->
  <div class="mt-5">
    <div class="accordion" id="auditAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingAudit">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAudit">
            Audit Logs
          </button>
        </h2>
        <div id="collapseAudit" class="accordion-collapse collapse">
          <div class="accordion-body">
            <ul id="auditLogList" class="list-group"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert -->
  <div class="alert alert-info mt-4">
    Only Admins and Site Managers can export. Audit logs are active for all actions.
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jsPDF Core -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- AutoTable Plugin (MUST come after jsPDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- Excel Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<!-- Bootstrap & Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const form = document.getElementById('reportForm');
  const result = document.getElementById('reportResult');
  const auditList = document.getElementById('auditLogList');
  const spinner = document.getElementById('loadingSpinner');
  const chips = document.getElementById('filterChips');
  const chartContainer = document.getElementById('chartContainer');
  const ctx = document.getElementById('reportChart').getContext('2d');
  let chartInstance;

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    result.style.display = 'none';
    chartContainer.style.display = 'none';
    chips.style.display = 'none';
    spinner.style.display = 'block';

    setTimeout(() => {
      spinner.style.display = 'none';
      result.style.display = 'block';
      chartContainer.style.display = 'block';
      chips.style.display = 'block';

      const reportType = document.getElementById('reportType').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      chips.innerHTML = `
        <span class="badge bg-primary">Type: ${reportType}</span>
        <span class="badge bg-dark">From: ${startDate}</span>
        <span class="badge bg-dark">To: ${endDate}</span>
      `;

      const reportData = getMockData(reportType);
      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = '';
      reportData.rows.forEach((row, index) => {
        tbody.innerHTML += `<tr><td>${index + 1}</td><td>${row.name}</td><td>${row.date}</td><td>${row.status}</td></tr>`;
      });

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: reportData.chartType,
        data: reportData.chartData,
        options: {
          plugins: { legend: { position: 'bottom' } },
          responsive: true
        }
      });

      const now = new Date().toLocaleString();
      const log = document.createElement('li');
      log.className = 'list-group-item';
      log.innerHTML = `<strong>${now}:</strong> Generated <em>${reportType}</em> report from <em>${startDate}</em> to <em>${endDate}</em>`;
      auditList.prepend(log);
    }, 1000);
  });


function downloadExcel() {
  const table = document.getElementById('reportTable');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb, ws, "Report");
  XLSX.writeFile(wb, "report.xlsx");
}


  function getMockData(type) {
    if (type === 'payroll') {
      return {
        chartType: 'bar',
        chartData: {
          labels: ['Site A', 'Site B', 'Site C'],
          datasets: [{
            label: 'Salary Paid',
            data: [120000, 95000, 135000],
            backgroundColor: '#38bdf8'
          }]
        },
        rows: [
          { name: 'Arun Kumar', date: '2025-07-10', status: 'â‚¹30,000' },
          { name: 'Fatima Ali', date: '2025-07-10', status: 'â‚¹32,000' }
        ]
      }
    } else if (type === 'vendor') {
      return {
        chartType: 'doughnut',
        chartData: {
          labels: ['Cement', 'Steel', 'Sand'],
          datasets: [{
            label: 'Transactions',
            data: [40, 25, 35],
            backgroundColor: ['#facc15', '#f87171', '#34d399']
          }]
        },
        rows: [
          { name: 'Ram Traders', date: '2025-07-11', status: 'Paid' },
          { name: 'Sai Bricks', date: '2025-07-11', status: 'Pending' }
        ]
      }
    } else {
      return {
        chartType: 'pie',
        chartData: {
          labels: ['Present', 'Absent'],
          datasets: [{
            data: [85, 15],
            backgroundColor: ['#16a34a', '#dc2626']
          }]
        },
        rows: [
          { name: 'John Doe', date: '2025-07-10', status: 'Present' },
          { name: 'Jane Smith', date: '2025-07-10', status: 'Absent' }
        ]
      }
    }
  }

async function downloadPDF() {
  const { jsPDF } = window.jspdf;

  const doc = new jsPDF();

  // Wait until autoTable plugin is ready
  if (typeof doc.autoTable !== 'function') {
    alert("jsPDF autoTable plugin not loaded.");
    return;
  }

  doc.text('Generated Report', 14, 15);
  doc.autoTable({
    html: '#reportTable',
    startY: 25,
    styles: { fontSize: 10 }
  });

  doc.save('report.pdf');
}



</script>
{% endblock %}
