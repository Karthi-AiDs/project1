{% extends 'base.html' %}
{% load static %}
{% load form_tags %}
{% block title %}Temporary User Portal{% endblock %}
{% block toggle_button %}{% endblock %}
{% block sidebar %}{% endblock %}  {# This removes the sidebar from base.html #}
{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Roboto', sans-serif;
    background-color: #f4f7fa;
    padding: 20px;
  }
  .form-section, .submission-history {
    background: #fff;
    padding: 20px;
    margin-top: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .form-section {
  background-color: #fff;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

.locked-section {
  background-color: #f8d7da;
  border-left: 5px solid #dc3545;
  padding: 20px;
  border-radius: 5px;
}

.locked-icon {
  font-size: 30px;
  color: #dc3545;
  margin-bottom: 10px;
}

  .submit-btn {
    background-color: #007bff;
    color: white;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  .submit-btn:hover {
    background-color: #0056b3;
  }
  .locked-section {
    padding: 20px;
    background-color: #f8d7da;
    border-radius: 12px;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  .status-badge {
    display: inline-block;
    background: #ffc107;
    color: #000;
    padding: 4px 10px;
    border-radius: 4px;
    margin-left: 15px;
    font-weight: bold;
  }
  .warning-banner, .restrictions-notice {
    background: #fff3cd;
    padding: 10px;
    border: 1px solid #ffeeba;
    border-radius: 8px;
    margin: 10px 0;
  }
  .countdown-timer {
    background-color: #d1ecf1;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 8px;
    color: #0c5460;
  }
  .history-item {
    padding: 10px;
    margin-bottom: 8px;
    border-bottom: 1px solid #ccc;
  }
  .status-editable {
    color: green;
  }
  .status-locked {
    color: red;
  }
</style>

<h2 style="text-align: center;">Temporary User Portal</h2>

<div class="user-info">
  <span>Temp ID: {{ request.user.id }}</span>
  <div class="status-badge">TEMPORARY ACCESS</div>
</div>

<div class="warning-banner">
  ‚ö† LIMITED ACCESS: You can only submit daily reports. No access to financials, attendance, or other system features.
</div>

<div class="restrictions-notice">
  <strong>Important:</strong> You have a 24-hour window to edit your submission. After that, it becomes read-only.
</div>

<!-- Daily Report Form Section -->
<div class="form-section mt-4">
  <h3>üìù Daily Report Submission - {{ current_time|date:"F d, Y" }}</h3>

  {% if existing and not existing.is_editable %}
    <div class="locked-section">
      <div class="locked-icon">üîí</div>
      <h3>Submission Locked</h3>
      <p>The 24-hour window to edit has expired. This submission is read-only.</p>
    </div>
  {% else %}
    {% if editable_time_left %}
      <div class="alert alert-info d-flex align-items-center" role="alert">
        ‚è∞ <span class="ms-2">Time left to edit: <strong id="countdown">{{ editable_time_left }}</strong></span>
      </div>
    {% endif %}

    <form method="post">
      {% csrf_token %}
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="id_site" class="form-label">Site:</label>
          {{ form.site|add_class:"form-control" }}
        </div>
        <div class="col-md-6">
          <label for="id_hours" class="form-label">Hours:</label>
          {{ form.hours|add_class:"form-control" }}
        </div>
      </div>

      <div class="mb-3">
        <label for="id_work_description" class="form-label">Work description:</label>
        {{ form.work_description|add_class:"form-control" }}
      </div>

      <button type="submit" class="btn btn-primary">Update Report</button>
    </form>
  {% endif %}
</div>


<!-- Submission History -->
<h3>üìã Your Submission History</h3>
<div class="submission-history">
  {% for report in reports %}
    <div class="history-item">
      <strong>{{ report.date|date:"F d, Y" }}</strong><br>
      Site: {{ report.site }} | Hours: {{ report.hours }} | Work: {{ report.work_description }}<br>

      {% if report.is_editable %}
        <span class="status-badge status-editable">Editable</span>
      {% else %}
        <span class="status-badge status-locked">üîí Locked</span>
      {% endif %}
    </div>
  {% empty %}
    <p>No submissions yet.</p>
  {% endfor %}
</div>


{% if existing and existing.is_editable %}
<script>
  // Countdown Timer Setup
  const submittedAt = new Date("{{ existing.submitted_at|date:'Y-m-d H:i:s' }}");
  const deadline = new Date(submittedAt.getTime() + 24 * 60 * 60 * 1000);

  function updateTimer() {
    const now = new Date();
    const diff = deadline - now;
    if (diff <= 0) {
      document.getElementById("timer").innerText = "00:00:00";
      location.reload();  // Refresh to show locked state
      return;
    }
    const hours = String(Math.floor(diff / 3600000)).padStart(2, '0');
    const minutes = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
    const seconds = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
    document.getElementById("timer").innerText = `${hours}:${minutes}:${seconds}`;
  }

  setInterval(updateTimer, 1000);
  updateTimer();
</script>
{% endif %}
{% endblock %}